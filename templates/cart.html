<!-- templates/cart.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Моя корзина</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-theme-bg-color: #ffffff;
            --tg-theme-text-color: #000000;
            --tg-theme-hint-color: #999999;
            --tg-theme-link-color: #3390ec;
            --tg-theme-button-color: #3390ec;
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-secondary-bg-color: #f4f4f5;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; margin: 0; padding: 15px; background-color: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); }
        h1 { margin-bottom: 20px; }
        #cart-items { margin-bottom: 20px; }
        .cart-item { display: flex; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--tg-theme-secondary-bg-color); padding-bottom: 15px; }
        .cart-item img { width: 70px; height: 70px; object-fit: cover; border-radius: 8px; margin-right: 15px; }
        .item-details { flex-grow: 1; }
        .item-details b { display: block; margin-bottom: 5px; }
        .quantity-controls { display: flex; align-items: center; }
        .quantity-controls button { width: 30px; height: 30px; border-radius: 50%; border: 1px solid var(--tg-theme-hint-color); background: none; color: var(--tg-theme-text-color); font-size: 18px; cursor: pointer; }
        .quantity-controls span { margin: 0 15px; font-weight: bold; }
        .item-price { font-weight: bold; }
        #total-price { font-size: 1.2em; font-weight: bold; text-align: right; }
        #checkout-form { margin-top: 20px; }
        #checkout-form input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid var(--tg-theme-hint-color); border-radius: 8px; background-color: var(--tg-theme-secondary-bg-color); color: var(--tg-theme-text-color); box-sizing: border-box; }
    </style>
</head>
<body>
    <h1>Ваша корзина</h1>
    <div id="cart-items"></div>
    <p id="total-price"></p>
    <div id="checkout-form" style="display: none;">
        <h3>Данные для доставки</h3>
        <input type="text" id="phone" placeholder="Ваш телефон для связи *">
        <input type="text" id="address" placeholder="Адрес (город, улица, дом) *">
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const userId = new URLSearchParams(window.location.search).get('user_id');
        const cartItemsContainer = document.getElementById('cart-items');
        const totalPriceEl = document.getElementById('total-price');
        const checkoutForm = document.getElementById('checkout-form');
        const mainButton = tg.MainButton;

        let cart = JSON.parse(localStorage.getItem('cart')) || {};

        function displayCart() {
            cartItemsContainer.innerHTML = '';
            let totalPrice = 0;
            const items = Object.values(cart);

            if (items.length === 0) {
                cartItemsContainer.innerHTML = '<p>Ваша корзина пуста. <a href="/?user_id=' + userId + '">Вернуться в магазин</a></p>';
                checkoutForm.style.display = 'none';
                mainButton.hide();
            } else {
                items.forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = 'cart-item';
                    itemEl.innerHTML = `
                        <img src="${item.image_url}" alt="${item.name}">
                        <div class="item-details">
                            <b>${item.name}</b>
                            <div class="quantity-controls">
                                <button onclick="changeQuantity(${item.id}, -1)">-</button>
                                <span>${item.quantity}</span>
                                <button onclick="changeQuantity(${item.id}, 1)">+</button>
                            </div>
                        </div>
                        <div class="item-price">${item.price * item.quantity} руб.</div>
                    `;
                    cartItemsContainer.appendChild(itemEl);
                    totalPrice += item.price * item.quantity;
                });
                checkoutForm.style.display = 'block';
                mainButton.setText(`Перейти к оплате ${totalPrice} руб.`);
                mainButton.show();
            }
            totalPriceEl.textContent = `Итого: ${totalPrice} руб.`;
        }

        function changeQuantity(productId, delta) {
            if (cart[productId]) {
                cart[productId].quantity += delta;
                if (cart[productId].quantity <= 0) {
                    delete cart[productId];
                }
                saveCartAndRedraw();
            }
        }

        function saveCartAndRedraw() {
            localStorage.setItem('cart', JSON.stringify(cart));
            displayCart();
            tg.HapticFeedback.impactOccurred('light');
        }

        mainButton.onClick(async () => {
            const phone = document.getElementById('phone').value;
            const address = document.getElementById('address').value;

            if (!phone || !address) {
                tg.showAlert('Пожалуйста, заполните телефон и адрес доставки.');
                return;
            }

            mainButton.showProgress(true).disable();

            const orderData = {
                user_id: userId,
                items: Object.values(cart),
                delivery_type: 'СДЭК', // Можно будет добавить выбор
                phone: phone,
                address: address,
                total_price: Object.values(cart).reduce((sum, item) => sum + item.price * item.quantity, 0)
            };

            try {
                const response = await fetch('/create_order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });
                const result = await response.json();

                if (result.status === 'success') {
                    // Очищаем корзину после успешного заказа
                    localStorage.removeItem('cart');
                    tg.showAlert(`Заказ #${result.order_id} успешно создан! Мы скоро свяжемся с вами.`);
                    tg.close();
                } else {
                    tg.showAlert(`Ошибка: ${result.message}`);
                }
            } catch (error) {
                tg.showAlert('Произошла сетевая ошибка. Попробуйте снова.');
            } finally {
                mainButton.hideProgress().enable();
            }
        });

        displayCart();
    </script>
</body>
</html>
