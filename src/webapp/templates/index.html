<!-- src/webapp/templates/index.html -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>VibesResell</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="{{ url_for('main.static', filename='css/styles.css') }}">
</head>
<body>
    <div id="app" v-cloak>
        <div id="loader" v-if="isLoading">
            <div class="spinner"></div>
        </div>

        <!-- MAIN VIEW (CATALOG, PRODUCT, CART) -->
        <div class="main-container" :class="{ 'view-product': currentView === 'product', 'view-cart': currentView === 'cart' }">

            <!-- CATALOG VIEW -->
            <div class="view" id="catalog-view">
                <div class="header">
                    <input type="text" v-model="searchQuery" placeholder="üîç –ü–æ–∏—Å–∫...">
                </div>
                <div class="filters">
                    <select v-model="filters.category">
                        <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                        <option>–ö—Ä–æ—Å—Å–æ–≤–∫–∏</option>
                        <option>–û–¥–µ–∂–¥–∞</option>
                    </select>
                    <select v-model="filters.brand">
                        <option value="">–í—Å–µ –±—Ä–µ–Ω–¥—ã</option>
                        <option v-for="brand in uniqueBrands" :key="brand" :value="brand">{{ brand }}</option>
                    </select>
                </div>
                <div class="product-grid">
                    <div v-for="product in filteredProducts" :key="product.id" class="product-card" @click="showProduct(product.id)">
                        <img :src="product.photo_url" :alt="product.name" loading="lazy">
                        <div class="product-card-info">
                            <h3>{{ product.name }}</h3>
                            <p class="price" v-if="product.min_price">–æ—Ç {{ product.min_price.toFixed(0) }} ‚ÇΩ</p>
                            <p v-else class="out-of-stock">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</p>
                        </div>
                    </div>
                    <p v-if="!isLoading && filteredProducts.length === 0" class="no-products">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</p>
                </div>
                 <!-- FLOATING CART ICON -->
                <div id="cart-icon" v-if="cartCount > 0" @click="showView('cart')">
                    üõí
                    <span id="cart-count">{{ cartCount }}</span>
                </div>
            </div>

            <!-- PRODUCT DETAIL VIEW -->
            <div class="view" id="product-view">
                <div v-if="currentProduct">
                    <div class="product-header">
                        <button class="back-btn" @click="showView('catalog')">‚Üê</button>
                    </div>
                    <img :src="currentProduct.photo_url" alt="" class="product-detail-img">
                    <h2>{{ currentProduct.name }}</h2>
                    <p class="brand"><strong>–ë—Ä–µ–Ω–¥:</strong> {{ currentProduct.brand }}</p>
                    <p class="description">{{ currentProduct.description }}</p>
                    <p class="composition"><strong>–°–æ—Å—Ç–∞–≤:</strong> {{ currentProduct.composition }}</p>
                    <div class="size-selector">
                        <button v-for="variant in currentProduct.variants" :key="variant.id"
                                class="size-btn"
                                :class="{ selected: selectedVariant && selectedVariant.id === variant.id }"
                                :disabled="variant.stock <= 0"
                                @click="selectVariant(variant)">
                            {{ variant.size }}
                        </button>
                    </div>
                    <div class="price-display" v-if="selectedVariant">{{ selectedVariant.price.toFixed(0) }} ‚ÇΩ</div>
                    <button id="add-to-cart-btn" class="action-button" @click="addToCart" :disabled="!selectedVariant">
                        {{ isProductInCart ? '–î–æ–±–∞–≤–ª–µ–Ω–æ' : '–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É' }}
                    </button>
                </div>
            </div>

            <!-- CART VIEW -->
            <div class="view" id="cart-view">
                <div class="cart-header">
                     <button class="back-btn" @click="showView('catalog')">‚Üê</button>
                     <h2>–ö–æ—Ä–∑–∏–Ω–∞</h2>
                </div>
                <div class="cart-content">
                    <div v-if="cartCount > 0">
                        <div v-for="item in cart" :key="item.variant_id" class="cart-item">
                            <img :src="item.photo_url" alt="">
                            <div class="cart-item-details">
                                <strong>{{ item.product_name }}</strong><br>
                                –†–∞–∑–º–µ—Ä: {{ item.size }} <br>
                                <span class="cart-item-price">{{ item.price.toFixed(0) }} ‚ÇΩ</span>
                            </div>
                            <div class="cart-item-controls">
                                <button @click="updateQuantity(item.variant_id, -1)">-</button>
                                <span>{{ item.quantity }}</span>
                                <button @click="updateQuantity(item.variant_id, 1)">+</button>
                            </div>
                        </div>
                    </div>
                    <div v-else class="empty-cart">
                        <p>–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.</p>
                    </div>
                </div>
                 <div class="cart-footer" v-if="cartCount > 0">
                    <div class="cart-total">–ò—Ç–æ–≥–æ: {{ cartTotal.toFixed(0) }} ‚ÇΩ</div>
                    <button id="place-order-btn" class="action-button" @click="placeOrder">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∑–∞–∫–∞–∑</button>
                </div>
            </div>

        </div>
    </div>
    <script src="{{ url_for('main.static', filename='js/app.js') }}"></script>
</body>
</html>